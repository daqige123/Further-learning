# 虚拟dom 树

### 什么是虚拟 dom 树？

虚拟 dom（this._vnode） 本质上就是一个 js 对象。就是 vue 框架设计用来表示实际 html dom 的一个 js 对象，里面包含了各种属性，比如 data、children、attributs等等。

每一个vue 组件都有一个 render 函数，render 函数就是用来生成虚拟 dom 树的，这就意味着每一个组件都对应着一颗虚拟 dom 树。

### 为什么需要虚拟dom树？

在vue 中，渲染视图的时候会调用 render 函数，这种渲染不仅发生在组件创建时，也发生在响应式数据更新时。

如果每一次就直接操作真实 dom，那么会带来极大的性能损耗，极大的降低渲染效率。

因此 vue 在渲染时，使用虚拟 dom 来代替真实 dom，主要是为解决 dom 的渲染效率问题。

### 虚拟dom是如何转换成真实dom的？

在一个组件实例首次被渲染的时候，它会先生成虚拟 dom 树，然后根据虚拟 dom 来创建真实 dom，并把正式 dom 挂载到合适的地方，此时每一个虚拟 dom 就会对应一个真实 dom。

如果一个组件的响应式数据更新，需要重新渲染的时候，它仍然会重新掉用 render 函数，创建出一个新的 dom 树，然后用新树和旧树做对比。通过对比来找到最小的更新量，然后更新必要的虚拟 dom 节点，然后通过虚拟 dom 来修改他们对应的真实 dom。

一句话，就是改虚拟 dom 比改真实 dom 更快，效率更高。

### 模板和虚拟dom之间的关系

vue 里面有一个 compile 模块，他的作用就是把 template 转换为 render 函数，而 render 函数掉用后就会返回一个虚拟 dom。

编译的过程分为两步：

1. 将模板字符串转换为 ast
2. 将 ast 转换为 render 函数。

> 注意： 如果使用传统的引入方式或 vue-cli 配置中开启了 **_runtimeCompiler：true_**，那么编译时间发生在组件第一次加载时，这称之为运行时编译。
>
> 如果是在 vue-cli 默认配置下，编译发生在打包时，这称之为模板预编译。
>
> 编译是一个极其耗时的操作，所以我们直接在打包的时候就把 template 给编译成 render 函数 了，这样就省掉了运行时再来编译的时间，同时已经编译好了，那么 compile 这一部分代码，也可以剔除出去，减小打包体积。
>
> 模板的存在，其实只是为了开发人员书写方便，看起来更舒服。

vue 最终运行的时候，最终需要的是 render 函数，而不是模板，因此，模板中的各种语法，在虚拟 dom 中都是不存在的，他们都会变成虚拟 dom 中的配置项。