#### 浏览器渲染html页面的过程

大致分为五步： 创建DOM树---创建样式表---创建render树---布局Layout--Painting.

1. 首先html解析器解析html元素， 构建DOM树。

2. css解析器解析css文件和元素上的内联样式，构建出样式表规则。

3. 将样式表和DOM树关联起来，生成render树。每个DOM节点都有**attach方法，接受样式信息**，返回一个render对象(又名renderer)。这些render对象最终会被构建成一颗Render树。

4. 布局：浏览器会根据render树确丁每一个节点的精确坐标。

5. 根据renders树，将页面一个像素一个像素的绘制出来，这个过程就叫paint。


##### 注：如果用js去操作dom的话，马上就会向上面的步骤一样全部执行一遍。



#### 重绘和回流

回流与DOM树和render树有关， 重绘跟render树有关。

1. 比如我们增删DOM节点，修改一个元素的宽高，页面布局发生变化，DOM树结构发生变化，那么肯定要重新构建DOM树，而DOM树与渲染树是紧密相连的，DOM树构建完，渲染树也会随之对页面进行再次渲染，**这个过程就叫回流**。

2. 当你给一个元素更换颜色，这样的行为是不会影响页面布局的，DOM树不会变化，但颜色变了，渲染树得重新渲染页面，**这就是重绘**

***\*也就是说，回流的代价要远大于重绘。且回流必然会造成重绘，但重绘不一定会造成回流。\****



结合上面的解释，引起DOM树结构变化，页面布局变化的行为叫回流，且回流一定伴随重绘。

只是样式的变化，不会引起DOM树变化，页面布局变化的行为叫重绘，且重绘不一定会便随回流。

### 页面优化

#### 减少重绘和回流

1.CSS

- 使用transform替代top
- 使用visibility替换display:none,因为前者只会引起重绘，后者会引发回流（改变了布局）
- 避免使用table布局，可能很小的一个改动会造成整个table的重新布局
- 尽可能在DOM树的最末端改变class，回流是不可避免的，但可以减少其影响。尽可能在DOM树的最末端改变class，可以限制了回流的范围。
- 避免设置多层内联样式，css选择符从右往左匹配查找，避免节点层级过多。
- 将动画效果应用到position属性为absolute或者fixed的元素上，避免影响其他元素的布局，这样只是一个重绘，而不是回流。同时，控制动画速度可以选择requestAnimationFrame。
- 避免使用css表达式，可能会引发回流。
- 将频繁重绘或者回流的节点设置为图层，图层能够阻止该节点的渲染行为影响别的节点，例如will-change,video,iframe等标签，浏览器会自动将该节点变为图层。
- CSS3硬件加速(GPU加速)，使用CSS3硬件加速，可以让transform,opacity,filters这些动画不会引起回流重绘。

2.JavaScript

- 避免频繁操作样式，最好一次性重写style属性，或者将样式列表定义为class并一次性更改class属性
- 避免频繁操作DOM，创建一个documentFragment，在它上面应用所有DOM操作，最后再把它添加到文档中。
- 避免频繁读取会引发回流/重绘的属性，如果确实需要多次使用，就用一个变量缓存起来。
- 对具有复杂动画的元素使用绝对定位，使它脱离文档流，否则会引起父元素及后续元素频繁回流。

